# 项目：AI智能提示词清洗节点 (ComfyUI x Zhipu AI)

**版本:** 2.0
**目标:** 创建一个ComfyUI自定义节点，该节点通过调用智谱AI的HTTP API，根据用户指令智能地清洗、过滤或重写输入的文本/提示词，并将处理后的结果输出，以供工作流中的其他节点使用。

---

## 第一章：节点总体设计

### 1.1. 核心功能

节点的核心是一个API调用器和Prompt组织器。它将接收非结构化的用户输入（原始文本和清洗指令），将它们构建成一个结构化的、高效的Prompt，发送给智谱AI的大语言模型进行处理，然后解析API的返回结果，最后输出纯净的文本。

### 1.2. 节点定义

- **内部类名 (Class Name):** `SafePrompt`
- **UI显示名称 (Display Name):** `SafePrompt`
- **节点分类 (Category):** `SafePrompt`

### 1.3. 认证方式

为了安全与便捷，节点的API密钥（API Key）采用配置文件模式。用户需在节点目录下创建一个`config.json`文件来提供密钥，节点启动时会自动读取，界面上不提供任何输入框。

---

## 第二章：模块化深度讲解与实现思路

### 模块一：节点输入接口 (`INPUT_TYPES`)

**深度讲解:**
这是节点在ComfyUI界面上暴露给用户的配置项。我们专注于核心的文本操作，同时提供必要的模型控制参数。

**详细实现思路:**

1. **`@classmethod def INPUT_TYPES(cls):`**: 在节点类中定义此方法。
2. **返回值**: 方法返回一个字典，包含`required`（必需项）。
3. **输入参数定义**:
   - **`prompt` (原始文本)**: `STRING` 类型, `{"multiline": True, "default": ""}`
   - **`instruction` (清洗指令)**: `STRING` 类型, `{"multiline": True, "default": "Remove all NSFW content."}`
   - **`model_name` (AI模型)**: `COMBO` (下拉菜单) 类型, `(["glm-4.5-flash", "glm-z1-flash", "glm-4.5"],)`
   - **`seed` (随机种子)**: `INT` 类型, `{"default": 0, "min": 0, "max": 2147483647}`

### 模块二：节点输出接口 (`RETURN_TYPES` & `RETURN_NAMES`)

**深度讲解:**
定义节点处理完成后向下游输出的数据。此节点的输出非常纯粹，只有一个清洗后的文本。

**详细实现思路:**

1. **`RETURN_TYPES = ("STRING",)`**: 定义输出一个字符串类型的数据。
2. **`RETURN_NAMES = ("cleaned_prompt",)`**: 为这个输出端口命名为`cleaned_prompt`。

### 模块三：核心执行逻辑 (`FUNCTION` & `execute` method)

**深度讲解:**
这是节点的心脏。它首先验证API密钥是否已通过配置文件成功加载，然后构建Prompt，调用API，最后处理并返回结果。

**详细实现思路:**

1. **`FUNCTION = "execute"`**: 将`execute`字符串赋值给`FUNCTION`。
2. **`def execute(self, ...):`**: 定义核心方法，接收所有输入作为参数。
3. **API密钥验证**: 在方法开头检查`self.api_key`是否存在。如果不存在，则抛出`ValueError`，提示用户配置`config.json`文件。
4. **构建Prompt**: 采用“系统角色”+“用户指令”的模式构建高效Prompt。
5. **调用API**: 调用封装好的API交互逻辑（详见模块四）。
6. **处理返回结果**: 对API返回的文本执行`.strip()`操作。
7. **返回输出**: `return (cleaned_text,)`，以元组形式返回结果。

### 模块四：API交互与依赖管理

**深度讲解:**
此模块负责与智谱AI服务器通信。它处理依赖库、身份验证、HTTP请求、响应解析和网络异常。

**详细实现思路:**

1. **依赖管理 (`requirements.txt`)**:
   - 文件内容为：`zai-sdk`。
2. **API密钥配置 (`config.json`)**:
   - 在节点根目录创建一个`config.json`文件。
   - 文件内容结构如下：
     ```json
     {
         "api_key": "YOUR_ZHIPU_API_KEY_HERE"
     }
     ```
   - 节点通过`__init__`构造函数加载并持有`api_key`。
3. **API调用与错误处理**:
   - 在`execute`方法中使用`try...except`块包裹API调用，使用从配置中加载的`self.api_key`进行认证。

---

## 第三章：项目结构与安装指南

### 3.1. 文件夹结构

```
ComfyUI/
└── custom_nodes/
    └── SafePrompt/
        ├── __init__.py           # 节点主代码
        ├── requirements.txt      # 内容为: zai-sdk
        └── config.json.example # 配置文件模板
```

### 3.2. 安装步骤

1. 将 `SafePrompt` 文件夹完整地放入 `ComfyUI/custom_nodes/` 目录下。
2. 打开您的终端或命令行工具。
3. 进入该节点目录: `cd path/to/ComfyUI/custom_nodes/SafePrompt`。
4. 安装所需的依赖库: `pip install -r requirements.txt`。
5. **配置API密钥**:
   - 编辑 `config.json` 文件，填入你的智谱AI API密钥。
6. **重启ComfyUI**。
